"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(_){return typeof _}:function(_){return _&&"function"==typeof Symbol&&_.constructor===Symbol&&_!==Symbol.prototype?"symbol":typeof _},_createClass=function(){function _(_,e){for(var i=0;i<e.length;i++){var t=e[i];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(_,t.key,t)}}return function(e,i,t){return i&&_(e.prototype,i),t&&_(e,t),e}}();function _toConsumableArray(_){if(Array.isArray(_)){for(var e=0,i=Array(_.length);e<_.length;e++)i[e]=_[e];return i}return Array.from(_)}function _classCallCheck(_,e){if(!(_ instanceof e))throw new TypeError("Cannot call a class as a function")}var Storage=function(){function _(e,i,t){if(_classCallCheck(this,_),this.__STORAGE__={},this.__STORAGE__.subscribers=[],t&&(this.__STORAGE__.parent=t),void 0!=e&&null!=e)if("object"!==(void 0===e?"undefined":_typeof(e))||Array.isArray(e)||e.NOT_STORAGE)Array.isArray(e)&&(this.__STORAGE__.value=[].concat(_toConsumableArray(e))),e.NOT_STORAGE&&(this.__STORAGE__.value=Object.assign({},e));else for(var r in e)this[r]=new _(e[r],void 0,this);else this.__STORAGE__.value=void 0!=i?i:null;var s=this;return this.__STORAGE__.methods={storage_update:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(i&&(s.__STORAGE__.parent=i),e.__STORAGE__.value||"object"!==(void 0===e?"undefined":_typeof(e))||Array.isArray(e))Array.isArray(e)?s.__STORAGE__.value=[].concat(_toConsumableArray(e)):s.__STORAGE__.value=e.__STORAGE__.value;else{for(var t in s)"__STORAGE__"!=t&&void 0===e[t]&&delete s[t];for(var r in e)"__STORAGE__"!=r&&(void 0!==s[r]&&"function"==typeof s[r].__STORAGE__.methods.storage_update&&s[r].__proto__===s.__proto__?s[r].__STORAGE__.methods.storage_update(e[r],i):s[r]=new _(e[r],void 0,s))}e&&e.__STORAGE__.subscribers&&(s.__STORAGE__.subscribers=e.__STORAGE__.subscribers)},subscribersCallingFromRoot:function(){for(var _=0;_<s.__STORAGE__.subscribers.length;_++)s.__STORAGE__.subscribers[_].callback(s.__STORAGE__.value);for(var e in s)"__STORAGE__"!=e&&s[e].__STORAGE__.methods.subscribersCallingFromRoot()},subscribersCallingToRoot:function(){for(var _=0;_<s.__STORAGE__.subscribers.length;_++)s.__STORAGE__.subscribers[_].callback();s.__STORAGE__.parent&&s.__STORAGE__.parent.__STORAGE__.methods.subscribersCallingToRoot()}},!0}return _createClass(_,[{key:"update",value:function(_){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.__STORAGE__.methods.storage_update(_),e||this.__STORAGE__.methods.subscribersCallingFromRoot()}},{key:"set",value:function(){var _=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.__STORAGE__.value=e;for(var i=function(e){"function"==typeof _.__STORAGE__.subscribers[e].callback?(_.__STORAGE__.subscribers[e].delayed?setTimeout(function(){_.__STORAGE__.subscribers[e].callback(_.__STORAGE__.value)},0):_.__STORAGE__.subscribers[e].callback(_.__STORAGE__.value),e++):_.__STORAGE__.subscribers.splice(e,1),t=e},t=0;t<this.__STORAGE__.subscribers.length;)i(t);return this.__STORAGE__.parent&&this.__STORAGE__.parent.__STORAGE__.methods.subscribersCallingToRoot(),!0}},{key:"get",value:function(){return this.__STORAGE__.value}},{key:"subscribe",value:function(_){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!1;if(!(arguments.length>2&&void 0!==arguments[2]&&arguments[2]))for(var t=0;t<this.__STORAGE__.subscribers.length;t++)if(this.__STORAGE__.subscribers[t]===_){i=!0;break}return i||this.__STORAGE__.subscribers.push({delayed:e,callback:_}),this.__STORAGE__.value}},{key:"sub",value:function(_,e,i){return this.subscribe(_,e,i)}},{key:"unsubscribe",value:function(_){for(var e=0;e<this.__STORAGE__.subscribers.length;e++)if(this.__STORAGE__.subscribers[e].callback===_){this.__STORAGE__.subscribers.splice(e,1);break}return this.__STORAGE__.value}},{key:"unsub",value:function(_){return this.unsubscribe(_)}},{key:"add",value:function(e,i){if("__STORAGE__"==e)throw"Resticted name '"+e+"'";return this[e]=new _(null,i,this),!0}},{key:"enableTimeTravelling",value:function(){var _=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;this.__STORAGE__.timeTravelling={},this.__STORAGE__.timeTravelling.frames=[this.clone()],this.__STORAGE__.timeTravelling.position=0,this.subscribe(function(){for(;_.__STORAGE__.timeTravelling.position>0;)_.__STORAGE__.timeTravelling.frames.shift(),_.__STORAGE__.timeTravelling.position--;_.__STORAGE__.timeTravelling.frames.length<e&&_.__STORAGE__.timeTravelling.frames.unshift(_.clone())})}},{key:"goBack",value:function(){var _=arguments.length>0&&void 0!==arguments[0]&&arguments[0];void 0!=this.__STORAGE__.timeTravelling&&this.__STORAGE__.timeTravelling.position<this.__STORAGE__.timeTravelling.frames.length-1&&(_?this.__STORAGE__.timeTravelling.position=this.__STORAGE__.timeTravelling.frames.length-1:this.__STORAGE__.timeTravelling.position++,this.update(this.__STORAGE__.timeTravelling.frames[this.__STORAGE__.timeTravelling.position],!0))}},{key:"goForward",value:function(){var _=arguments.length>0&&void 0!==arguments[0]&&arguments[0];void 0!=this.__STORAGE__.timeTravelling&&this.__STORAGE__.timeTravelling.position>0&&(_?this.__STORAGE__.timeTravelling.position=0:this.__STORAGE__.timeTravelling.position--,this.update(this.__STORAGE__.timeTravelling.frames[this.__STORAGE__.timeTravelling.position],!0))}},{key:"clone",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=new _(null,void 0,i);e&&(t.__STORAGE__.subscribers=[].concat(_toConsumableArray(this.__STORAGE__.subscribers))),this.__STORAGE__.value&&(t.__STORAGE__.value=this.__STORAGE__.value),i&&(t.__STORAGE__parent=i);for(var r in this)"__STORAGE__"!=r&&(t[r]=this[r].clone(e,t));return t}}]),_}();exports.default=Storage;